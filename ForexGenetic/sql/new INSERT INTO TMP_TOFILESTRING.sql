SET feedback ON;
SET ECHO ON;
SPOOL ON;

TRUNCATE TABLE TMP_TOFILESTRING2;

--SELECT COUNT(*) FROM TMP_TOFILESTRING2;

INSERT INTO TMP_TOFILESTRING2 (ID_INDIVIDUO, CRITERIO_ORDER1, CRITERIO_ORDER2, VIGENCIA1, VIGENCIA2)
  SELECT PRE_TFS.ID_INDIVIDUO, MIN(PRE_TFS.PIPS_TOTALES), MIN(PRE_TFS.PIPS_SEMANA),
  PRE_TFS.FECHA_SEMANA, PRE_TFS.FECHA_SEMANA+7	
  FROM PREVIO_TOFILESTRING PRE_TFS
	INNER JOIN ESTRATEGIA_OPERACION_PERIODO PERI
		ON ( NVL(PRE_TFS.PIPS_SEMANA,0)>PERI.FILTRO_PIPS_X_SEMANA AND PRE_TFS.PIPS_MES>PERI.FILTRO_PIPS_X_MES 
			AND PRE_TFS.PIPS_ANYO>PERI.FILTRO_PIPS_X_ANYO AND PRE_TFS.PIPS_TOTALES>PERI.FILTRO_PIPS_TOTALES) 
			AND PRE_TFS.TIPO_OPERACION=PERI.TIPO_OPERACION
      AND PRE_TFS.FECHA_SEMANA BETWEEN PERI.FECHA_FINAL AND ADD_MONTHS(PERI.FECHA_FINAL,1)
  WHERE 
  --( PERI.ID IN (615214,615326,611410,609954,611298,609842,615310,615198,615482)
  --)
	(PERI.PIPS_TOTALES>5000 AND PERI.ID BETWEEN 116681 AND 140756 --1293268 AND 1313435
	  AND PERI.PIPS_TOTALES_PARALELAS>0 AND PERI.PIPS_TOTALES>0 
	  AND (PERI.PIPS_AGRUPADO_MINUTOS>0 AND PERI.PIPS_AGRUPADO_HORAS>0 AND PERI.PIPS_AGRUPADO_DIAS>0)
	  AND (PERI.CANTIDAD_PARALELAS/PERI.CANTIDAD)<10)
  GROUP BY PRE_TFS.ID_INDIVIDUO, PRE_TFS.FECHA_SEMANA;
commit;

@"d:ricardorq85\JavaProjects\Git\genetic-forex\ForexGenetic\sql\ToFileStringFromTEMP_TOFILESTRING.sql";
