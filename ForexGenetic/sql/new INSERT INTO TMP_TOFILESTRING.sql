SET feedback ON;
SET ECHO ON;
SPOOL ON;

TRUNCATE TABLE TMP_TOFILESTRING2;

INSERT INTO TMP_TOFILESTRING2 (ID_INDIVIDUO, CRITERIO_ORDER1, CRITERIO_ORDER2, VIGENCIA1, VIGENCIA2)
  SELECT PTFS.ID_INDIVIDUO, 
	ROUND((MIN(PTFS.PIPS_SEMANA)+MIN(PTFS.PIPS_MES)+MIN(PTFS.PIPS_ANYO)+MIN(PTFS.PIPS_TOTALES))/3), 
	MIN(PTFS.PIPS_TOTALES),
  PTFS.FECHA_SEMANA, PTFS.FECHA_SEMANA+7
  FROM PREVIO_TOFILESTRING PTFS
	INNER JOIN ESTRATEGIA_OPERACION_PERIODO PERI
		ON ( NVL(PTFS.PIPS_SEMANA,0)>PERI.FILTRO_PIPS_X_SEMANA AND PTFS.PIPS_MES>PERI.FILTRO_PIPS_X_MES 
			AND PTFS.PIPS_ANYO>PERI.FILTRO_PIPS_X_ANYO AND PTFS.PIPS_TOTALES>PERI.FILTRO_PIPS_TOTALES)
			AND PTFS.TIPO_OPERACION=PERI.TIPO_OPERACION      
	  AND PTFS.FECHA_SEMANA BETWEEN PERI.FECHA_FINAL AND ADD_MONTHS(PERI.FECHA_FINAL,1)
	  AND PTFS.PENDIENTE_CONSOL>0 AND PTFS.PENDIENTE_ANYO>0 AND PTFS.PENDIENTE_MES>0 --AND PTFS.PENDIENTE_SEMANA>0
  WHERE 
	(PERI.PIPS_TOTALES>0 AND 
	  PERI.ID BETWEEN 1627690 AND 11627690 
	  AND PERI.PIPS_TOTALES_PARALELAS>0 
	  AND PERI.PIPS_TOTALES>0 
	  AND (PERI.PIPS_AGRUPADO_MINUTOS>0 AND PERI.PIPS_AGRUPADO_HORAS>0 AND PERI.PIPS_AGRUPADO_DIAS>0)
	  --AND (PERI.PIPS_AGRUPADO_MINUTOS>PERI.PIPS_AGRUPADO_HORAS AND PERI.PIPS_AGRUPADO_HORAS>PERI.PIPS_AGRUPADO_DIAS)
	  AND (PERI.CANTIDAD_PARALELAS/PERI.CANTIDAD)<10
	  )
	  AND PERI.FECHA_FINAL>TO_DATE('20131231','YYYYMMDD')
  GROUP BY PTFS.ID_INDIVIDUO, PTFS.FECHA_SEMANA;
commit;

@"d:ricardorq85\JavaProjects\Git\genetic-forex\ForexGenetic\sql\ToFileStringFromTEMP_TOFILESTRING.sql";
